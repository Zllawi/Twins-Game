<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <title>ุฅูุดุงุก ูุนุจุฉ ุฌุฏูุฏุฉ | ูุนุจุฉ ุงููุงููุง</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="game-styles.css">
    <link rel="stylesheet" href="waiting-animation.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>๐ญ</text></svg>">
    
    <!-- ุฅุถุงูุฉ ููุชุจุงุช Firebase - ุชุญููู ุงูุฅุตุฏุงุฑ ุงููุชูุงูู -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <a href="index.html" class="back-link">ุงูุนูุฏุฉ ููุฑุฆูุณูุฉ</a>
                <h1>ุฅูุดุงุก ูุนุจุฉ ุฌุฏูุฏุฉ</h1>
            </div>
            <div class="separator"></div>
        </header>

        <!-- ุดุงุดุฉ ุชุญููู ูุงูุชุธุงุฑ ุชููุฆุฉ Firebase -->
        <div id="loading-firebase" style="text-align: center; margin: 20px 0;">
            <div style="display: inline-block; width: 50px; height: 50px; border: 3px solid rgba(233, 64, 87, 0.3); border-radius: 50%; border-top-color: #e94057; animation: spin 1s linear infinite;"></div>
            <p>ุฌุงุฑู ุงูุงุชุตุงู ุจุงูุฎุงุฏู...</p>
        </div>

        <!-- ุฑุณุงูุฉ ุงูุฎุทุฃ ุณุชุธูุฑ ููุง ุฅุฐุง ูุงู ููุงู ูุดููุฉ ูู ุงูุงุชุตุงู -->
        <div id="connection-error" style="display:none; background-color: #ffebee; color: #c62828; padding: 15px; border-radius: 5px; margin: 20px 0; text-align: center;">
            <h3 style="margin-top: 0;">ุฎุทุฃ ูู ุงูุงุชุตุงู</h3>
            <p id="error-message">ุญุฏุซุช ูุดููุฉ ูู ุงูุงุชุตุงู ุจุงูุฎุงุฏู. ุชุฃูุฏ ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช ูุญุงูู ูุฑุฉ ุฃุฎุฑู.</p>
            <a href="connection-error.html" style="display:inline-block; margin-top:10px; background: #e94057; color: white; padding: 8px 15px; border-radius: 5px; text-decoration: none;">ุนุฑุถ ุงูุชูุงุตูู ูุงูุญููู</a>
            <div style="margin-top: 15px;">
                <button onclick="retryConnection()" style="background-color: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ุฅุนุงุฏุฉ ุงููุญุงููุฉ</button>
            </div>
        </div>

        <main class="setup-form" style="display: none;">
            <div class="form-group">
                <label for="playerName">ุงุณูู:</label>
                <input type="text" id="playerName" placeholder="ุฃุฏุฎู ุงุณูู" required>
            </div>
            
            <div class="form-group">
                <label for="playerCount">ุนุฏุฏ ุงููุงุนุจูู:</label>
                <select id="playerCount">
                    <option value="4">4 ูุงุนุจูู</option>
                    <option value="5">5 ูุงุนุจูู</option>
                    <option value="6">6 ูุงุนุจูู</option>
                    <option value="7">7 ูุงุนุจูู</option>
                    <option value="8">8 ูุงุนุจูู</option>
                    <option value="9">9 ูุงุนุจูู</option>
                    <option value="10">10 ูุงุนุจูู</option>
                </select>
            </div>
            
            <button class="btn primary-btn" id="createGameBtn">ุฅูุดุงุก ุงููุนุจุฉ</button>
        </main>

        <div class="game-info" style="display: none;">
            <h2>ุชู ุฅูุดุงุก ุงููุนุจุฉ!</h2>
            <p>ุดุงุฑู ูุฐุง ุงูุฑูุฒ ูุน ุฃุตุฏูุงุฆู ููุงูุถูุงู:</p>
            <div class="game-code-box">
                <span id="gameCode">XXXX</span>
                <button id="copyCode" class="copy-btn">ูุณุฎ</button>
            </div>
            
            <div class="waiting-animation">
                <div class="character">
                    <div class="hair"></div>
                </div>
                <div class="coat"></div>
                <div class="sword"></div>
                <div class="dot dot-1"></div>
                <div class="dot dot-2"></div>
                <div class="dot dot-3"></div>
            </div>
            
            <div class="waiting-text">
                ุจุงูุชุธุงุฑ ุงูุถูุงู ุงููุงุนุจูู... <span id="playerCounter">1</span>/<span id="totalPlayers">8</span>
            </div>
            
            <button class="btn primary-btn" id="startGameBtn" disabled>ุจุฏุก ุงููุนุจุฉ</button>
        </div>
    </div>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <!-- ุชุญููู ููู ุชูููู Firebase -->
    <script src="firebase-config.js"></script>

    <script>
        let firebaseCheckCount = 0;
        const maxChecks = 20;
        let checkInterval;
        
        // ุงูุชุญูู ูู ุงูุงุชุตุงู ุจุงููุงูุฑุจูุณ
        document.addEventListener('DOMContentLoaded', function() {
            console.log("ุจุฏุก ุงูุชุญูู ูู ุงุชุตุงู Firebase...");
            checkInterval = setInterval(checkFirebase, 500);
            
            // ูู ุญุงูุฉ ุงุณุชูุฑุงุฑ ุงูุชุญููู ููุชุฑุฉ ุทูููุฉุ ูุธูุฑ ุฎุทุฃ
            setTimeout(function() {
                if (document.getElementById('loading-firebase').style.display !== 'none') {
                    clearInterval(checkInterval);
                    showConnectionError("ุงุณุชุบุฑู ุงูุงุชุตุงู ููุชุงู ุทูููุงู. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงูู ุจุงูุฅูุชุฑูุช.");
                }
            }, 10000);
        });
        
        // ูุธููุฉ ููุชุญูู ูู ุชุญููู Firebase
        function checkFirebase() {
            firebaseCheckCount++;
            console.log("ูุญุงููุฉ ุงูุชุญูู ูู Firebase: " + firebaseCheckCount);
            
            if (typeof firebase !== 'undefined' && typeof window.database !== 'undefined') {
                clearInterval(checkInterval);
                console.log("ุชู ุชุญููู Firebase ุจูุฌุงุญ");
                
                document.getElementById('loading-firebase').style.display = 'none';
                document.querySelector('.setup-form').style.display = 'block';
                
                // ุงูุชุญูู ูู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุงูุจูุงูุงุช
                try {
                    const testRef = firebase.database().ref(".info/connected");
                    testRef.on("value", function(snap) {
                        if (snap.val() !== true) {
                            console.warn("ุบูุฑ ูุชุตู ุจู Firebase");
                            showConnectionError("ูุง ูููู ุงูุงุชุตุงู ุจูุงุนุฏุฉ ุจูุงูุงุช Firebase. ูุฏ ุชููู ููุงู ูุดููุฉ ูู ุงูุฅุนุฏุงุฏุงุช.");
                        }
                    });
                } catch (error) {
                    console.error("ุฎุทุฃ ูู ุงูุงุชุตุงู ุจู Firebase:", error);
                    showConnectionError("ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจู Firebase: " + error.message);
                }
            } else if (firebaseCheckCount >= maxChecks) {
                clearInterval(checkInterval);
                document.getElementById('loading-firebase').style.display = 'none';
                console.error("ูุดู ุชุญููู ููุชุจุฉ Firebase ุจุนุฏ ุนุฏุฉ ูุญุงููุงุช");
                showConnectionError("ูู ูุชู ุชุญููู ููุชุจุฉ Firebase. ูุฏ ุชููู ููุงู ูุดููุฉ ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช ุฃู ุญุธุฑ ูู ุงููุชุตูุญ.");
                
                // ูุญุงููุฉ ุชุญููู Firebase ูุจุงุดุฑุฉ
                loadFirebaseDirect();
            }
        }
        
        // ูุธููุฉ ูุชุญููู Firebase ุจุดูู ูุจุงุดุฑ
        function loadFirebaseDirect() {
            console.log("ูุญุงููุฉ ุชุญููู Firebase ุจุดูู ูุจุงุดุฑ...");
            
            const script1 = document.createElement('script');
            script1.src = "https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js";
            document.head.appendChild(script1);
            
            script1.onload = function() {
                const script2 = document.createElement('script');
                script2.src = "https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js";
                document.head.appendChild(script2);
                
                script2.onload = function() {
                    // ุฅุนุงุฏุฉ ุชุญููู ููู ุงูุชูููู
                    const configScript = document.createElement('script');
                    configScript.src = "firebase-config.js";
                    document.head.appendChild(configScript);
                    
                    // ุฅุนุงุฏุฉ ุงููุญุงููุฉ ุจุนุฏ ุงูุชุญููู
                    configScript.onload = function() {
                        setTimeout(retryConnection, 1000);
                    };
                };
            };
        }
        
        // ูุธููุฉ ูุฅุนุงุฏุฉ ูุญุงููุฉ ุงูุงุชุตุงู
        function retryConnection() {
            document.getElementById('connection-error').style.display = 'none';
            document.getElementById('loading-firebase').style.display = 'block';
            
            // ุฅุนุงุฏุฉ ุงููุญุงููุฉ
            firebaseCheckCount = 0;
            checkInterval = setInterval(checkFirebase, 500);
        }
        
        // ุนุฑุถ ุฑุณุงูุฉ ุฎุทุฃ ุงูุงุชุตุงู
        function showConnectionError(message) {
            const errorDiv = document.getElementById('connection-error');
            const errorMsg = document.getElementById('error-message');
            
            errorMsg.textContent = message;
            errorDiv.style.display = 'block';
            
            // ุชุนุทูู ุฒุฑ ุฅูุดุงุก ุงููุนุจุฉ
            document.getElementById('createGameBtn').disabled = true;
        }
    </script>

    <!-- ุชุญููู ููู ุฅูุดุงุก ุงููุนุจุฉ ุจุนุฏ ุงูุชุฃูุฏ ูู ุชุญููู Firebase -->
    <script src="create-game.js"></script>
</body>
</html> 